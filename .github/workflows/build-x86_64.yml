name: Build Void x86_64 ISO

on:
  workflow_dispatch:
    inputs:
      datecode:
        description: 'Optional datecode (default: today UTC)'
        required: false
        type: string

jobs:
  build-iso:
    name: Build Void ISO (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Install host dependencies
        run: |
          sudo apt update
          sudo apt install -y xz-utils lzop dosfstools e2fsprogs squashfs-tools \
            binutils bzip2 curl ca-certificates git gawk build-essential \
            texinfo unzip libarchive-tools libtool autopoint gettext

      - name: Download & install xbps-static (musl)
        run: |
          set -e

          # 1. 下载最新 musl 静态包 (x86_64-musl 版)
          curl -LO https://repo-default.voidlinux.org/static/xbps-static-latest.x86_64-musl.tar.xz

          # 2. 解压到 /opt/xbps：解出来的 usr/ 就是我们要的二进制目录
          sudo mkdir -p /opt/xbps
          sudo tar -xf xbps-static-latest.x86_64-musl.tar.xz -C /opt/xbps

          #    注意：解压后会得到 /opt/xbps/usr 和 /opt/xbps/var 两个目录，
          #    其中 /opt/xbps/usr/bin/xbps-* 就是运行时所需的所有工具。

          # 3. 把 /opt/xbps/usr/bin 加入 PATH
          echo "/opt/xbps/usr/bin" >> $GITHUB_PATH

          # 4. 验证一下版本（可选）
          xbps-install -V

      - name: Clone void-packages
        run: |
          git clone https://github.com/void-linux/void-packages

      - name: Binary bootstrap
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Set DATECODE
        id: date
        run: |
          if [ -z "${{ inputs.datecode }}" ]; then
            echo "datecode=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"
          else
            echo "datecode=${{ inputs.datecode }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build base-system
        run: |
          cd void-packages
          ./xbps-src -N pkg base-system

      - name: Index local repository
        run: |
          cd void-packages
          /opt/xbps/usr/bin/xbps-rindex -a hostdir/binpkgs/*.xbps

      - name: Clone void-mklive
        run: |
          git clone https://github.com/void-linux/void-mklive
          cd void-mklive
          make

      - name: Build ISO with local repo
        run: |
          cd void-mklive
          sudo ./mklive.sh \
            -a x86_64 \
            -r ../void-packages/hostdir/binpkgs \
            -o void-x86_64-${{ steps.date.outputs.datecode }}.iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: void-x86_64-${{ steps.date.outputs.datecode }}.iso
          path: void-mklive/void-x86_64-${{ steps.date.outputs.datecode }}.iso
