name: Build Void x86_64 ISO

on:
  workflow_dispatch:
    inputs:
      datecode:
        description: 'Optional datecode (default: today UTC)'
        required: false
        type: string

jobs:
  build-iso:
    name: Build Void ISO (x86_64)
    runs-on: ubuntu-latest

    steps:
      - name: Install host dependencies
        run: |
          sudo apt update
          sudo apt install -y xz-utils lzop dosfstools e2fsprogs squashfs-tools \
            binutils bzip2 curl ca-certificates git gawk build-essential \
            texinfo unzip libarchive-tools libtool autopoint gettext

      - name: Install bsdtar and symlink it
        run: |
          sudo apt install -y bsdtar
          sudo ln -sf /usr/bin/bsdtar /usr/bin/tar

      - name: Download xbps-static
        run: |
          curl -LO https://repo-default.voidlinux.org/static/xbps-static-latest.tar.xz
          tar -xf xbps-static-latest.tar.xz
          sudo mv xbps-static /opt/xbps
          echo "/opt/xbps/usr/bin" >> $GITHUB_PATH

      - name: Clone void-packages
        run: |
          git clone https://github.com/void-linux/void-packages

      - name: Binary bootstrap
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Set DATECODE
        id: date
        run: |
          if [ -z "${{ inputs.datecode }}" ]; then
            echo "datecode=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"
          else
            echo "datecode=${{ inputs.datecode }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build base-system
        run: |
          cd void-packages
          ./xbps-src -N pkg base-system

      - name: Index local repository
        run: |
          cd void-packages
          /opt/xbps/usr/bin/xbps-rindex -a hostdir/binpkgs/*.xbps

      - name: Clone void-mklive
        run: |
          git clone https://github.com/void-linux/void-mklive
          cd void-mklive
          make

      - name: Build ISO with local repo
        run: |
          cd void-mklive
          sudo ./mklive.sh \
            -a x86_64 \
            -r ../void-packages/hostdir/binpkgs \
            -o void-x86_64-${{ steps.date.outputs.datecode }}.iso

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: void-x86_64-${{ steps.date.outputs.datecode }}.iso
          path: void-mklive/void-x86_64-${{ steps.date.outputs.datecode }}.iso
