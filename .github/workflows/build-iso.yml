name: Build Void ISO from Scratch

on:
  workflow_dispatch:
    inputs:
      datecode:
        description: "Optional datecode (defaults to today-UTC)"
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 0) 取当前仓库（fork 的 void-mklive）
      - uses: actions/checkout@v4

      # 1) 用上面的 Dockerfile 构建自定义镜像
      - name: Build custom builder image
        run: |
          docker build -t void-builder:latest container

      # 2) 在容器里执行完整流程
      - name: Run build inside container
        run: |
          set -e
          # 生成 DATECODE
          if [ -z "${{ inputs.datecode }}" ]; then
            DATECODE=$(date -u +%Y%m%d)
          else
            DATECODE=${{ inputs.datecode }}
          fi

          docker run --rm --privileged \
            -e DATECODE="$DATECODE" \
            -v "$PWD":/workspace \
            -w /workspace \
            void-builder:latest bash -c '
              set -e
              export PATH=/opt/xbps/usr/bin:$PATH
              export XBPS_ALLOW_ROOT=yes        # ② 全局允许 root 运行 xbps-src
          
              # Ⅰ. clone void-packages 并构建 base-system + 必需工具
              git clone --depth 1 https://github.com/void-linux/void-packages.git
              cd void-packages
              echo XBPS_CHROOT_CMD=bwrap >> etc/conf     # 用 bubblewrap
          
              ./xbps-src binary-bootstrap
              ./xbps-src -N pkg base-system kmod squashfs-tools
              xbps-rindex -a hostdir/binpkgs/*.xbps
              cd ..
          
              # Ⅱ. 把刚编好的 kmod 与 squashfs-tools 安装进容器运行环境
              xbps-install -y -R void-packages/hostdir/binpkgs \
                kmod squashfs-tools
          
              # Ⅲ. 编译并运行 mklive 生成 ISO
              make
              ./mklive.sh -a x86_64 \
                -r /workspace/void-packages/hostdir/binpkgs \
                -o /workspace/void-x86_64-${DATECODE}.iso
            '


      # 3) 上传生成的 ISO
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: void-x86_64-${{ inputs.datecode || 'latest' }}
          path: void-x86_64-*.iso
